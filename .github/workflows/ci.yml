# Inlined CI — see ADR-011 §Pragmatic CI (skillbar-ai/decisions)
name: CI

on:
  pull_request:
  push:
    branches: [main]

defaults:
  run:
    shell: bash -euo pipefail {0}

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          fetch-depth: 0

      - name: Verify jq version (>= 1.6)
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq is not installed"
            exit 1
          fi
          version="$(jq --version | sed 's/^jq-//')"
          required="1.6"
          if [[ "$(printf '%s\n' "$required" "$version" | sort -V | head -n1)" != "$required" ]]; then
            echo "jq version $version is below required $required"
            exit 1
          fi
          echo "jq version $version meets minimum $required"

      - name: Install shellcheck and shfmt
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends shellcheck
          go install mvdan.cc/sh/v3/cmd/shfmt@v3.8.0
          echo "$HOME/go/bin" >> "$GITHUB_PATH"

      - name: Discover shell files
        id: discover
        run: |
          {
            git ls-files '*.sh' '*.bash'
            git ls-files | while IFS= read -r f; do
              [[ "$f" == *.sh || "$f" == *.bash ]] && continue
              [[ -f "$f" ]] && head -1 "$f" | grep -qE '^#!.*\b(ba)?sh\b' && echo "$f"
            done
          } | sort -u > /tmp/shell-files-raw.txt
          mapfile -t files < /tmp/shell-files-raw.txt
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            printf '%s\n' "${files[@]}" > /tmp/shell-files.txt
          fi

      - name: Enforce shell formatting (shfmt)
        if: steps.discover.outputs.has_files == 'true'
        run: |
          mapfile -t shell_files < /tmp/shell-files.txt
          shfmt -d -i 2 -ci -bn "${shell_files[@]}"

      - name: Shellcheck
        if: steps.discover.outputs.has_files == 'true'
        run: |
          mapfile -t shell_files < /tmp/shell-files.txt
          shellcheck -x "${shell_files[@]}"

      - name: Bash syntax check
        if: steps.discover.outputs.has_files == 'true'
        run: |
          mapfile -t shell_files < /tmp/shell-files.txt
          for f in "${shell_files[@]}"; do
            bash -n "$f"
          done

      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests
        run: |
          if [[ -f Makefile ]] && grep -Eq '^test:([[:space:]]|$)' Makefile; then
            echo "Running make test"
            make test
          else
            echo "No Makefile test target found; skipping tests"
          fi
